name: Build and Push Docker Image

# When this workflow runs
on:
  push:
    branches: [ main ]  # Run on pushes to main branch
  pull_request:
    branches: [ main ]  # Run on PRs targeting main branch

# Environment variables available to all jobs
env:
  REGISTRY: ghcr.io                    # GitHub Container Registry URL
  IMAGE_NAME: ${{ github.repository }} # Uses repo name (owner/repo-name)

jobs:
  build:
    runs-on: ubuntu-latest  # Use latest Ubuntu runner
    
    # Permissions needed for this job
    permissions:
      contents: read   # Read repository contents
      packages: write  # Push to GitHub Container Registry

    steps:
    # Download the repository code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Log into GitHub Container Registry using built-in token
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}           # ghcr.io
        username: ${{ github.actor }}           # GitHub username that triggered workflow
        password: ${{ secrets.GITHUB_TOKEN }}   # Auto-generated token for this workflow

    # Generate tags and labels for the Docker image
    - name: Extract metadata
      id: meta  # ID to reference outputs from this step
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}  # Full image name
        tags: |
          type=ref,event=branch      # Branch name (e.g., main)
          type=ref,event=pr          # PR number (e.g., pr-123)
          type=sha,format=short      # Short commit SHA (e.g., abc1234)

    # Build Docker image and push to registry
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .                              # Build from repository root
        push: true                              # Push image to registry
        tags: ${{ steps.meta.outputs.tags }}    # Use tags generated above
        labels: ${{ steps.meta.outputs.labels }} # Use labels generated above